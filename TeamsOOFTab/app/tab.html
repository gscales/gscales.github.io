<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Teams In/Out Board</title>
    <style>
        img {
            border-radius: 50%;
        }
    </style>
</head>
<body>    
    <div id="data"></div>
    <link rel="stylesheet" href="https://appsforoffice.microsoft.com/fabric/2.1.0/fabric.min.css" />
    <link rel="stylesheet" href="https://appsforoffice.microsoft.com/fabric/2.1.0/fabric.components.min.css" />
    <script src="https://secure.aadcdn.microsoftonline-p.com/lib/1.0.13/js/adal.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.js"
            integrity="sha256-Qw82+bXyGq6MydymqBxNPYTaUXXq7c8v3CwiYwLLNXU="
            crossorigin="anonymous"></script>
    <script src="https://statics.teams.microsoft.com/sdk/v0.2/js/MicrosoftTeams.min.js"></script>
    <script type="text/javascript">
        // Initialize microsoft teams tab library
        microsoftTeams.initialize();
        var token = null;

        function uuidv4() {
            function hex(s, b) {
                return s +
                    (b >>> 4).toString(16) +  // high nibble
                    (b & 0b1111).toString(16);   // low nibble
            }

            let r = crypto.getRandomValues(new Uint8Array(16));

            r[6] = r[6] >>> 4 | 0b01000000; // Set type 4: 0100
            r[8] = r[8] >>> 3 | 0b10000000; // Set variant: 100

            return r.slice(0, 4).reduce(hex, '') +
                r.slice(4, 6).reduce(hex, '-') +
                r.slice(6, 8).reduce(hex, '-') +
                r.slice(8, 10).reduce(hex, '-') +
                r.slice(10, 16).reduce(hex, '-');
        }

        // getData function to perform auth flow and get user's Data
        var refresh = function() {
            if (token == null)
            {
                microsoftTeams.authentication.authenticate({
                    url: "/TeamsOOFTab/app/auth.html",
                    width: 400,
                    height: 400,
                    successCallback: function(t) {
                        // Note: token is only good for one hour
                        token = t;
                        Graphex(token);
                    },
                    failureCallback: function(err) {
                        document.getElementById("auth").innerText("Failed to get authenticate and get token.");
                    }
                });
            }
            else
                getData(token);
        };

        var Graphex = function (token) {
            var GroupId = "cc1b7acb-4431-4798-80b5-e64a81b4c45f";
            // Use XMLHttpRequest to call Microsoft Graph for the users data
            var req = new XMLHttpRequest();
            req.open("GET", ("https://graph.microsoft.com/v1.0/groups/" + GroupId + "/members"), false);
            req.setRequestHeader("Authorization", "Bearer " + token);
            req.setRequestHeader("Accept", "application/json;odata.metadata=minimal;");
            req.send();
            var result = JSON.parse(req.responseText);
            var MailTipsRquest = {};
            var EmailAddresses = [];
            MailTipsRquest.EmailAddresses = EmailAddresses;
            MailTipsRquest.MailTipsOptions = "automaticReplies";
            var displayNameMap = {};
            for (index = 0; index < result.value.length; ++index) {
                var entry = result.value[index];
                MailTipsRquest.EmailAddresses.push(entry.mail);
                var emAddress = entry.mail;
                displayNameMap[entry.mail] = entry.displayName;
            }
            var PostURL = "https://graph.microsoft.com/beta/me/getMailTips";
            var mtipRequest = JSON.stringify(MailTipsRquest);
            $.ajax({
                type: "POST",
                contentType: "application/json; charset=utf-8",
                url: PostURL,
                data: mtipRequest,
                dataType: 'json',
                headers: { 'Authorization': 'Bearer ' + token }
            }).done(function (item) {
                var html = "<div class=\"ms-Table\" style=\"border-collapse:collapse;border: 1px solid black;table-layout: auto;width:75%;\;background-color:white;"><div class=\"ms-Table-row\">";
                html = html + "<span class=\"ms-Table-cell\" style=\"background-color: #EEEEEE;font-size: large;width:50px;\"></span>";
                html = html + "<span class=\"ms-Table-cell\" style=\"background-color: #EEEEEE;font-size: large;width:100px;\">User</span>";
                html = html + "<span class=\"ms-Table-cell\" style=\"background-color: #EEEEEE;font-size: large;\">Out of Office Message</span>";
                html = html + "</div>";
                var index = 0;
                for (index = 0; index < item.value.length; ++index) {
                    var entry = item.value[index];
                    var DisplayName = displayNameMap[entry.emailAddress.address];
                    if (entry.hasOwnProperty("automaticReplies")) {
                        var outval = false;
                        if (entry.automaticReplies.hasOwnProperty("message")) {
                            if (entry.automaticReplies.message.length > 5) {
                                outval = true;
                            }
                        }

                        if (outval) {
                            html = html + "<div class=\"ms-Table-row\"><span class=\"ms-Table-cell\" style=\"width:50px;\"><img id=\"img" + entry.emailAddress.address + "\" style=\"border: 2px solid red;\" src=\"\" /></span>";
                        } else {
                            html = html + "<div class=\"ms-Table-row\"><span class=\"ms-Table-cell\" style=\"width:50px;\"><img id=\"img" + entry.emailAddress.address + "\" style=\"border: 2px solid green;\" src=\"\" /></span>";
                        }
                    }

                    html = html + "<span class=\"ms-Table-cell ms-fontWeight-semibold\" style=\"vertical-align: middle;width:120px;\">" + DisplayName + "</span>";
                    html = html + "<span id=\"OffStatus\" class=\"ms-Table-cell\" style=\"vertical-align: middle;\">";
                    if (entry.automaticReplies.hasOwnProperty("message")) {
                        html = html + entry.automaticReplies.message + "</span ></div >";
                    } else {
                        html = html + "</span ></div >";
                    }

                }
                html = html + "</div>";
                $('#data').append(html);
                var photoRequestMap = {};
                for (index = 0; index < result.value.length; ++index) {
                    var entry = result.value[index];
                    var clientid = uuidv4();
                    photoRequestMap[clientid] = entry.mail;
                    var userImageURL = "https://graph.microsoft.com/v1.0/users('" + entry.mail + "')/photos/48x48/$value";
                    var xhr = new XMLHttpRequest();
                    xhr.open('GET', userImageURL, true);
                    xhr.setRequestHeader("Authorization", "Bearer " + token);
                    xhr.setRequestHeader("client-request-id", clientid);
                    xhr.responseType = 'arraybuffer';
                    xhr.onload = function (e) {
                        if (this.status == 200) {
                            // get binary data as a response
                            var blob = this.response;
                            var clientRespHeader = this.getResponseHeader("client-request-id")
                            var ElemendId = "img" + photoRequestMap[clientRespHeader];
                            var uInt8Array = new Uint8Array(this.response);
                            var i = uInt8Array.length;
                            var binaryString = new Array(i);
                            while (i--) {
                                binaryString[i] = String.fromCharCode(uInt8Array[i]);
                            }
                            var data = binaryString.join('');
                            var base64 = window.btoa(data);
                            document.getElementById(ElemendId).src = "data:image/png;base64," + base64;
                           
                        }
                    };

                    xhr.send()





                }
            }).fail(function (error) {
                // Handle error
            });


        };

        refresh();
    </script>
</body>
</html>